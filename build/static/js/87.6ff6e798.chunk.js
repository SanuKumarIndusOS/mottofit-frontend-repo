(this.webpackJsonpmotto=this.webpackJsonpmotto||[]).push([[87],{324:function(e,n,t){"use strict";t.r(n),t.d(n,"updatePersonTyping",(function(){return u})),t.d(n,"resetChannelDetails",(function(){return l})),t.d(n,"updateMessagingDetails",(function(){return d})),t.d(n,"updateGlobalMessagingDetails",(function(){return p})),t.d(n,"initClientDispatch",(function(){return g})),t.d(n,"unSubscribeFromChannel",(function(){return h})),t.d(n,"unSubscribeFromClient",(function(){return f})),t.d(n,"updateMessageUnReadCount",(function(){return y}));var a=t(36),i=t(5),r=t(109),s=t(15),o=t(334),c=t(6),u=function(e){return function(n,t){var a=t().messagingReducer,i=a.typingMembers,o=a.currentChannelMembers,c=e.type,u=e.participant.state.identity,l=i,d=(localStorage.getItem("user-id"),o.filter((function(e){return e.userIdenity===u}))[0]||{}),p=(null===d||void 0===d?void 0:d.userName)||u;"typingStarted"===c?i.includes(p)||(l=[].concat(Object(r.a)(i),[p]),n({type:s.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:{typingMembers:Object(r.a)(l)}})):"typingEnded"===c&&i.includes(p)&&(l=Object(r.a)(i).filter((function(e){return e!==p})),n({type:s.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:{typingMembers:Object(r.a)(l)}}))}},l=function(){return function(e){e({type:s.MessagingActionType.RESET_CHANNEL_DETAILS})}},d=function(e){return function(n){n({type:s.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:e})}},p=function(e){return function(n,t,a){var i,o,c,u,l=a.api,d=null===e||void 0===e||null===(i=e.channel)||void 0===i?void 0:i.sid,p=null===e||void 0===e||null===(o=e.state)||void 0===o?void 0:o.body,g=null===e||void 0===e||null===(c=e.state)||void 0===c?void 0:c.author,h=t().messagingReducer,f=h.pastSessions,b=h.upcomingSessions,m=h.adminMessages,S=h.invitedSessions,T=h.requestedSessions,A=h.userMessages,C=h.trainerMessages,E=h.activeChannel,M=Object(r.a)(f),j=Object(r.a)(b),I=Object(r.a)(S),O=Object(r.a)(m),D=Object(r.a)(T),w=Object(r.a)(A),_=Object(r.a)(C),k=function(e,a){return y(e,a)(n,t,{api:l})},x=v(M,d,p,g,E,k),L=v(j,d,p,g,E,k),P=v(D,d,p,g,E,k),G=v(I,d,p,g,E,k),N={pastSessions:x,upcomingSessions:L,requestedSessions:P,adminMessages:v(O,d,p,g,E,k),userMessages:v(w,d,p,g,E,k),trainerMessages:v(_,d,p,g,E,k),invitedSessions:G},U=document.getElementsByClassName("message_left");null===(u=Object(r.a)(U))||void 0===u||u.forEach((function(e){return null===e||void 0===e?void 0:e.scrollTo(0,0)})),n({type:s.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:N})}},g=function(e,n){return function(t,a){t({type:s.MessagingActionType.UPDATE_CLIENT_INSTANCE,payload:new o.default(t,a,e,n)})}},h=function(){return function(e,n){var t=n().messagingReducer.chatClientInstance;t&&t.unSubscribeChannel()}},f=function(){return function(e,n){var t=n().messagingReducer.chatClientInstance;t&&t.removeChatClient()}},v=function(e,n,t,a,s,o){var c=Object(r.a)(e).map((function(e){var r=Object(i.a)({},e);if((null===e||void 0===e?void 0:e.channelId)===n){Object.keys(r).includes("message")||(r.message={}),r.message.body=t,r.message.date_updated=(new Date).toISOString(),r.message.from=a,console.log(r);var c=localStorage.getItem("user-id");if(!(a===c))if(r.channelId===s.sid){var u={channelSid:s.sid,unRead:0,userId:c},l=window.location.pathname,d="";d=l.includes("admins")?l.split("/")[3]||"":l.split("/")[4]||"",o(u,d)}else r.unReadCount=(r.unReadCount||0)+1}return console.log(r),Object(i.a)({},r)})),u=(c=c.sort((function(e,n){var t,a;return new Date((null===n||void 0===n||null===(t=n.message)||void 0===t?void 0:t.date_updated)||1950)-new Date((null===e||void 0===e||null===(a=e.message)||void 0===a?void 0:a.date_updated)||1950)}))).filter((function(e,n,t){return n===t.findIndex((function(n){return n.channelId===e.channelId}))}));return Object(r.a)(u)},y=function(e,n){return function(t,o,u){var l=u.api;return new Promise((function(u,d){var p=c.TrainerApi.updateUnReadCount;p.body=e,l(Object(i.a)({},p)).then((function(c){console.log(c);var u={invited:"invitedSessions",upcoming:"upcomingSessions",past:"pastSessions",admin:"adminMessages",requested:"requestedSessions",user:"userMessages",trainer:"trainerMessages"}[n],l=o().messagingReducer,d=Object(r.a)(l[u]||[]);if(console.log(e,n),(null===d||void 0===d?void 0:d.length)>0){var p=d.map((function(n){var t=Object(i.a)({},n);return(null===n||void 0===n?void 0:n.channelId)===e.channelSid&&(t.unReadCount=0!==e.unRead?parseInt(t.unReadCount||0)+1:e.unRead),t})),g=Object(a.a)({},u,Object(r.a)(p));t({type:s.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:g})}})).catch((function(e){console.log(e)}))}))}}},334:function(e,n,t){"use strict";t.r(n),t.d(n,"default",(function(){return v}));var a=t(5),i=t(109),r=t(14),s=t.n(r),o=t(28),c=t(20),u=t(21),l=t(15),d=t(6),p=t(112),g=t(38),h=t(324),f=t(871),v=function(){function e(n,t,r,u){var v=this;Object(c.a)(this,e),this.initClient=Object(o.a)(s.a.mark((function e(){var n,t;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.getToken();case 2:return n=e.sent,e.next=5,f.Client.create(n);case 5:t=e.sent,v.client=t,v.handler({type:l.MessagingActionType.INITIALIZE_CLIENT,payload:t}),v.initClientListeners(t);case 9:case"end":return e.stop()}}),e)}))),this.initClientListeners=function(e){e.removeAllListeners(),e.on("messageAdded",function(){var e=Object(o.a)(s.a.mark((function e(n){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("global"),v.globalMessage(n);case 2:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()),e.on("typingStarted",(function(e){v.onParticipantStartTyping(e)})),e.on("typingEnded",(function(e){v.onParticipantEndedTyping(e)})),e.on("tokenAboutToExpire",Object(o.a)(s.a.mark((function n(){var t;return s.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return v.log("token is about to expire"),n.next=3,v.getToken();case 3:t=n.sent,e.updateToken(t);case 5:case"end":return n.stop()}}),n)})))),e.on("tokenExpired",Object(o.a)(s.a.mark((function n(){var t;return s.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return v.log("token is about to expire"),n.next=3,v.getToken();case 3:t=n.sent,e.updateToken(t);case 5:case"end":return n.stop()}}),n)})))),v.cachedChannelId&&v.joinChannelByID(v.cachedChannelId,!0).catch((function(e){Object(g.Toast)({type:"error",message:e.message||"Error"}),v.callBackFn()}))},this.globalMessage=function(e){Object(h.updateGlobalMessagingDetails)(e)(v.handler,v.getState,{api:p.api,Toast:g.Toast})},this.handleCurrentChannelMessage=function(){var e=Object(o.a)(s.a.mark((function e(n){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("global 2"),e.next=3,v.onMessagedAdded(n);case 3:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),this.joinChannelByID=function(){var e=Object(o.a)(s.a.mark((function e(n){var t,a=arguments;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>1&&void 0!==a[1]&&a[1],e.abrupt("return",new Promise(function(){var e=Object(o.a)(s.a.mark((function e(a,i){var r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t||v.unSubscribeChannel(),v.client){e.next=4;break}return e.abrupt("return",alert("Twilio loading"));case 4:return v.handler({type:l.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:{isLoading:!0}}),v.log("Attempting to join ".concat(n," channel")),e.next=8,v.client.getChannelByUniqueName(n);case 8:return r=e.sent,e.next=11,v.joinChannel(r);case 11:return e.next=13,v.onChanelJoined(r);case 13:v.log("Channel joined"),v.activeChannel=r,r.on("messageAdded",v.handleCurrentChannelMessage),r.on("typingStarted",(function(e){v.onParticipantStartTyping(e)})),r.on("typingEnded",(function(e){v.onParticipantEndedTyping(e)})),r.on("memberJoined",(function(e){v.onMemberJoined(e)})),r.on("memberLeft",(function(e){v.onMemberLeft(e)})),v.handler({type:l.MessagingActionType.UPDATE_CHANNEL_DETAILS,payload:r}),a(!0),e.next=28;break;case 24:e.prev=24,e.t0=e.catch(0),v.log("Not able to join the channel"),i(e.t0);case 28:case"end":return e.stop()}}),e,null,[[0,24]])})));return function(n,t){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),this.joinChannel=function(){var e=Object(o.a)(s.a.mark((function e(n){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("joined"===n.channelState.status){e.next=3;break}return e.next=3,n.join();case 3:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),this.onChanelJoined=function(){var e=Object(o.a)(s.a.mark((function e(n){var t,a;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.getMessages();case 2:t=e.sent,a=t.items||[],v.handler({type:l.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:{activeChannelMessages:Object(i.a)(a),isLoading:!1}});case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),this.onMessagedAdded=function(){var e=Object(o.a)(s.a.mark((function e(n){var t,a,r,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.channel.sid===(null===(t=v.activeChannel)||void 0===t?void 0:t.sid)){e.next=6;break}return console.log(n,"msg","diff channel"),e.abrupt("return",{});case 6:return e.next=8,v.activeChannel.getMessages();case 8:return a=e.sent,r=a.items,o=void 0===r?[]:r,console.log(a,"channelMessages"),e.abrupt("return",v.handler({type:l.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:{activeChannelMessages:Object(i.a)(o),isLoading:!1}}));case 12:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),this.onParticipantStartTyping=function(e){if((e.state||{}).identity!==localStorage.getItem("user-id")){var n={type:"typingStarted",participant:e};Object(h.updatePersonTyping)(n)(v.handler,v.getState)}},this.onParticipantEndedTyping=function(e){if((e.state||{}).identity!==localStorage.getItem("user-id")){var n={type:"typingEnded",participant:e};Object(h.updatePersonTyping)(n)(v.handler,v.getState)}},this.onMemberJoined=function(e){var n=e.state.identity;return v.log("".concat(n," has joined the chat")),v.handler({type:l.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:{status:"".concat(n," has joined the chat")}})},this.onMemberLeft=function(e){var n=e.state.identity;return v.log("".concat(n," has left the chat")),v.handler({type:l.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:{status:"".concat(n," has left the chat")}})},this.getToken=function(){var e=d.twilioApi.getIdentityToken;return e.id=localStorage.getItem("user-id"),new Promise((function(n,t){Object(p.api)(Object(a.a)({},e)).then((function(e){var t=e.chatToken;n(t)})).catch((function(e){Object(g.Toast)({type:"error",message:e.message||"Error"}),t(e)}))}))},this.unSubscribeChannel=function(){v.activeChannel&&v.activeChannel.leave().then((function(e){v.activeChannel=null,v.log("Un subscribed from the channel")})),Object(h.resetChannelDetails)()(v.handler)},this.removeChatClient=function(){v.client&&(v.client.removeAllListeners(),v.client=null,v.handler({type:l.MessagingActionType.UPDATE_MESSAGING_DETAILS,payload:{clientData:null}}),v.unSubscribeChannel(),v.log("chat client removed"))},this.getState=t,this.handler=n,this.activeChannel=null,this.client=null,this.cachedChannelId=r,this.callBackFn=u,this.initClient()}return Object(u.a)(e,[{key:"log",value:function(e){console.log("---------".concat(e,"------"))}}]),e}()},885:function(e,n){},890:function(e,n){}}]);